version: '{branch}-{build}'

branches:
  only:
    - master
    - /^v\d+\.\d+\.\d+[\w\-]*$/

install:
  - "SET PATH=C:\\Python27;C:\\Python27\\Scripts;%PATH%"
  - "SET TOX_TESTENV_PASSENV=HOME USERPROFILE HOMEPATH HOMEDRIVE"
  - "pip install -U tox twine wheel"
  # Force pip 7.1.2 in binary, to avoid https://github.com/pypa/pip/issues/3383
  # Can most probably be removed when pip 8.0.1 is released
  - "python -m pip install --upgrade pip==7.1.2"

# No build stage, binaries are built in 'freeze' test environment
build: false

test_script:
  - tox -e py27,freeze

artifacts:
  - path: dist\shub.exe
  - path: dist\shub-$(APPVEYOR_REPO_TAG_NAME)-windows.zip

after_test:
  - 7z a dist\shub-%APPVEYOR_REPO_TAG_NAME%-windows.zip %APPVEYOR_BUILD_FOLDER%\dist\shub.exe

deploy:
  provider: GitHub
  auth_token:
    secure: mNA38grRkwGjw4zSUX1qA67eE6CRPjk97hRngZf19FuopBwbpPjOALBIlYZWKlDv
  artifact: dist\shub-$(APPVEYOR_REPO_TAG_NAME)-windows.zip
  draft: true
  on:
    appveyor_repo_tag: true
